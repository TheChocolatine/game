<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Super 2D X100</title>
<style>
body{margin:0;overflow:hidden;background:#111;}
canvas{display:block;background:#222;}
#scoreboard{position:absolute;top:10px;left:10px;color:white;font-family:monospace;}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="scoreboard"></div>
<script>
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');
canvas.width=600; canvas.height=600;
const scoreboard=document.getElementById('scoreboard');

let ws=null;
let myId=null;
const players={};
const bullets=[];
const powerups=[];
const keys={};
const mouse={x:0,y:0,down:false};
const local={x:300,y:300,hp:100,color:'#56CCF2',lastShoot:0};

function connect(){
  ws=new WebSocket(window.location.origin.replace(/^http/,"ws"));
  ws.onopen=()=>console.log("Connected");
  ws.onmessage=e=>{
    const msg=JSON.parse(e.data);
    if(msg.t==="init"){ myId=msg.id; msg.players.forEach(p=>players[p.id]=p); bullets.push(...msg.bullets); powerups.push(...msg.powerups);}
    else if(msg.t==="state"){ 
      msg.players.forEach(p=>players[p.id]=p);
      bullets.length=0; bullets.push(...msg.bullets);
      powerups.length=0; powerups.push(...msg.powerups);
    }
  };
}

function shoot(){
  if(Date.now()-local.lastShoot>200){
    local.lastShoot=Date.now();
    const dx=mouse.x-local.x;
    const dy=mouse.y-local.y;
    const angle=Math.atan2(dy,dx);
    if(ws && ws.readyState===WebSocket.OPEN)
      ws.send(JSON.stringify({t:'shoot', x:local.x, y:local.y, angle}));
  }
}

function update(){
  if(keys['w']) local.y-=local.speed||3;
  if(keys['s']) local.y+=local.speed||3;
  if(keys['a']) local.x-=local.speed||3;
  if(keys['d']) local.x+=local.speed||3;
  if(mouse.down) shoot();
  if(ws && ws.readyState===WebSocket.OPEN)
    ws.send(JSON.stringify({t:'update', x:local.x, y:local.y, hp:local.hp}));
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // powerups
  powerups.forEach(p=>{
    ctx.fillStyle=p.type==='heal'?'#0f0':p.type==='speed'?'#0ff':'#f0f';
    ctx.beginPath();
    ctx.arc(p.x,p.y,8,0,2*Math.PI);
    ctx.fill();
  });

  // bullets
  bullets.forEach(b=>{
    ctx.fillStyle=b.color;
    ctx.beginPath();
    ctx.arc(b.x,b.y,5,0,2*Math.PI);
    ctx.fill();
  });

  // players
  for(const id in players){
    const p=players[id];
    ctx.fillStyle=p.color;
    ctx.beginPath();
    ctx.arc(p.x,p.y,10,0,2*Math.PI);
    ctx.fill();

    // HP bar
    ctx.fillStyle='red';
    ctx.fillRect(p.x-10,p.y-20,20*(p.hp/100),3);
  }

  // local player on top
  ctx.fillStyle=local.color;
  ctx.beginPath();
  ctx.arc(local.x,local.y,10,0,2*Math.PI);
  ctx.fill();

  // scoreboard
  const arr=Object.values(players).sort((a,b)=>b.score-a.score);
  scoreboard.innerHTML = arr.map(p=>p.id===myId?'YOU: '+p.score:p.name+': '+p.score).join('<br>');
}

function loop(){ update(); draw(); requestAnimationFrame(loop); }

window.addEventListener('keydown',e=>keys[e.key.toLowerCase()]=true);
window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);
canvas.addEventListener('mousemove',e=>{ mouse.x=e.offsetX; mouse.y=e.offsetY; });
canvas.addEventListener('mousedown',()=>mouse.down=true);
canvas.addEventListener('mouseup',()=>mouse.down=false);

connect(); loop();
</script>
</body>
</html>
